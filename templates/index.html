<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worksmart - Track Easily</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .logo h1 {
            color: #5a67d8;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .logo .slogan {
            color: #666;
            font-style: italic;
            font-size: 1.1em;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }
        
        .facility-info {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            margin-left: 15px;
        }
        
        .nav-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .nav-tab {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90, 103, 216, 0.4);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #4c51bf, #553c9a);
            box-shadow: 0 4px 12px rgba(90, 103, 216, 0.6);
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #5a67d8;
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.1);
        }
        
        .search-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }
        
        .content-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            min-height: 600px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notifications {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #e53e3e;
        }
        
        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(229, 62, 62, 0.2);
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90, 103, 216, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3182ce, #2c5aa0);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .table th {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table tr:hover {
            background: #f7fafc;
        }
        
        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-active { background: #c6f6d5; color: #22543d; }
        .status-inactive { background: #fed7d7; color: #742a2a; }
        .status-due { background: #fed7d7; color: #742a2a; }
        .status-overdue { background: #e53e3e; color: white; }
        .status-defaulter { background: #2d3748; color: white; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #5a67d8;
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f7fafc);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 2% auto;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }
        
        .close:hover {
            color: #e53e3e;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin: 100px auto;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .facility-selector {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #5a67d8;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-color: #48bb78;
        }
        
        .alert-warning {
            background: #faf089;
            color: #744210;
            border-color: #ed8936;
        }
        
        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border-color: #e53e3e;
        }
        
        .alert-info {
            background: #bee3f8;
            color: #2c5aa0;
            border-color: #3182ce;
        }
        
        .file-upload {
            border: 2px dashed #5a67d8;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #4c51bf;
            background: #edf2ff;
        }
        
        .trace-card {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #38b2ac;
            position: relative;
        }
        
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .hidden {
            display: none;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .coordinates-display {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            border-left: 4px solid #3182ce;
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-input {
                margin-bottom: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="logo">
                <h1>Worksmart</h1>
                <p class="slogan">Track Easily - Professional ART Management</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Enter password" required>
                </div>
                
                <!-- Facility Selection (will be shown after successful login) -->
                <div id="facilitySelection" class="facility-selector hidden">
                    <h3 style="margin-bottom: 15px; color: #2d3748;">Select Your Facility</h3>
                    <div class="form-group">
                        <select id="facilitySelect" class="form-input" required>
                            <option value="">Choose Facility...</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <p><strong>Note:</strong> You can only view and manage clients from your selected facility. Contact system administrator if you need access to multiple facilities.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn" style="width: 100%;" id="loginButton">Login</button>
                </div>
                <p style="margin-top: 20px; color: #666;">
                    Don't have an account? 
                    <a href="#" id="registerLink" style="color: #5a67d8; text-decoration: none; font-weight: 600;">Request Access</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="header">
                <div class="logo">
                    <h1>Worksmart</h1>
                    <p class="slogan">Track Easily - Professional ART Management</p>
                </div>
                <div class="user-info">
                    <div>
                        <span>Welcome, <strong id="currentUser"></strong></span>
                        <span id="userRole" style="margin-left: 10px; padding: 5px 10px; background: #5a67d8; color: white; border-radius: 15px; font-size: 12px;"></span>
                        <span id="currentFacility" class="facility-info"></span>
                    </div>
                    <div>
                        <button id="switchFacilityBtn" class="btn btn-info" style="margin-right: 10px;">üè• Switch Facility</button>
                        <button id="logoutBtn" class="btn btn-danger">Logout</button>
                    </div>
                </div>
            </div>

            <div class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
                    <button class="nav-tab" data-tab="notifications">üîî Notifications</button>
                    <button class="nav-tab" data-tab="tx-curr">üìà TX-Curr</button>
                    <button class="nav-tab" data-tab="reports">üìã Reports</button>
                    <button class="nav-tab" data-tab="trace">üó∫Ô∏è Client Trace</button>
                    <button class="nav-tab admin-only" data-tab="account-requests">üë• Account Requests</button>
                    <button class="nav-tab admin-only" data-tab="facilities">üè• Facilities</button>
                    <button class="nav-tab admin-only" data-tab="analytics">üìä Analytics</button>
                </div>
                
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search clients by ART number, name, address...">
                    <button id="searchBtn" class="search-btn">üîç Search</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">Dashboard Overview</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalClients">0</div>
                            <div class="stat-label">Total Clients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeClients">0</div>
                            <div class="stat-label">Active on ART</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="dueToday">0</div>
                            <div class="stat-label">Due Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="overdue">0</div>
                            <div class="stat-label">Overdue</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="showModal('addClientModal')">‚ûï Add Client</button>
                        <button class="btn btn-success" onclick="showPharmacyDue('today')">üìã Due Today</button>
                        <button class="btn btn-warning" onclick="showPharmacyDue('week')">üìÖ This Week</button>
                        <button class="btn" onclick="showModal('importModal')">üìÅ Import Data</button>
                        <button class="btn btn-info" onclick="exportBackup()">üíæ Backup Data</button>
                    </div>

                    <div id="clientsList">
                        <!-- Client list will be populated here -->
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div id="notifications" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">Notifications & Reminders</h2>
                    <div id="notificationsList">
                        <div class="notifications">
                            <h3 style="margin-bottom: 15px; color: #e53e3e;">‚ö†Ô∏è Urgent Reminders</h3>
                            <div id="urgentNotifications">
                                <!-- Notifications will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TX-Curr Tab -->
                <div id="tx-curr" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">TX-Curr Management</h2>
                    <div class="alert alert-info">
                        <p><strong>TX-Curr Status Rules:</strong></p>
                        <p>‚Ä¢ Active: Client is currently on treatment and up-to-date</p>
                        <p>‚Ä¢ Inactive: Client has been marked as IIT, Dead, Defaulter, or Transfer Out</p>
                        <p>‚Ä¢ Reactivation: Only possible through clinical visit entry by authorized personnel</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="showModal('importModal')">üìÅ Import TX-Curr Data</button>
                        <button class="btn btn-success" onclick="exportTxCurr()">üì§ Export Current Data</button>
                    </div>
                    <div id="txCurrTable">
                        <!-- TX-Curr table will be populated here -->
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">Reports & Analytics</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9ff; padding: 20px; border-radius: 15px; border: 2px solid #5a67d8;">
                            <h3 style="color: #5a67d8; margin-bottom: 15px;">üìÖ Pharmacy Reports</h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button class="btn" onclick="generatePharmacyReport('today')">Due Today</button>
                                <button class="btn" onclick="generatePharmacyReport('tomorrow')">Due Tomorrow</button>
                                <button class="btn" onclick="generatePharmacyReport('week')">This Week</button>
                                <button class="btn" onclick="generatePharmacyReport('month')">This Month</button>
                            </div>
                        </div>
                        
                        <div style="background: #f0fff4; padding: 20px; border-radius: 15px; border: 2px solid #48bb78;">
                            <h3 style="color: #48bb78; margin-bottom: 15px;">üè• Clinical Reports</h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button class="btn btn-success" onclick="generateClinicalReport('vl')">VL Due</button>
                                <button class="btn btn-success" onclick="generateClinicalReport('cervical')">Cervical Screening</button>
                                <button class="btn btn-success" onclick="generateClinicalReport('eac')">EAC Sessions</button>
                            </div>
                        </div>
                        
                        <div style="background: #fffaf0; padding: 20px; border-radius: 15px; border: 2px solid #ed8936;">
                            <h3 style="color: #ed8936; margin-bottom: 15px;">üìç Location Reports</h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <input type="text" id="villageInput" class="form-input" placeholder="Enter village name" style="margin-bottom: 10px;">
                                <button class="btn btn-warning" onclick="generateLocationReport()">Generate Report</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="reportResults">
                        <!-- Report results will be displayed here -->
                    </div>
                </div>

                <!-- Client Trace Tab -->
                <div id="trace" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">üó∫Ô∏è Client Tracing System</h2>
                    
                    <div class="alert alert-info">
                        <p><strong>Client Tracing Guide:</strong></p>
                        <p>‚Ä¢ Search for overdue clients who need follow-up</p>
                        <p>‚Ä¢ Use GPS coordinates to locate clients</p>
                        <p>‚Ä¢ Record tracing activities and outcomes</p>
                        <p>‚Ä¢ Update client status based on findings</p>
                    </div>
                    
                    <div class="search-container" style="margin-bottom: 30px;">
                        <input type="text" id="traceSearchInput" class="search-input" placeholder="Search client for tracing...">
                        <button id="traceSearchBtn" class="search-btn" onclick="searchClientsForTracing()">üîç Find Client</button>
                    </div>
                    
                    <div id="traceResults">
                        <div class="alert alert-warning">
                            <h4>üéØ Quick Actions</h4>
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn btn-danger" onclick="showOverdueClients()">Show Overdue Clients</button>
                                <button class="btn btn-warning" onclick="showDefaulterClients()">Show Defaulters</button>
                                <button class="btn btn-info" onclick="showClientsWithCoordinates()">Show Clients with GPS</button>
                            </div>
                        </div>
                        <div id="traceClientsList">
                            <p style="text-align: center; color: #666; padding: 40px;">Search for a client to begin tracing</p>
                        </div>
                    </div>
                </div>

                <!-- Account Requests Tab (Admin Only) -->
                <div id="account-requests" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">Account Requests Management</h2>
                    <div id="accountRequestsList">
                        <!-- Account requests will be populated here -->
                    </div>
                </div>

                <!-- Facilities Tab (Admin Only) -->
                <div id="facilities" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">Facility Management</h2>
                    <div class="alert alert-info">
                        <p><strong>Facility Management:</strong> Add, edit, or manage healthcare facilities in the system.</p>
                    </div>
                    <button class="btn" onclick="showModal('addFacilityModal')" style="margin-bottom: 20px;">‚ûï Add New Facility</button>
                    <div id="facilitiesList">
                        <!-- Facilities will be populated here -->
                    </div>
                </div>

                <!-- Analytics Tab (Admin Only) -->
                <div id="analytics" class="tab-content">
                    <h2 style="margin-bottom: 20px; color: #2d3748;">System Analytics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeFacilities">0</div>
                            <div class="stat-label">Active Facilities</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalSystemClients">0</div>
                            <div class="stat-label">Total System Clients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthlyUpdates">0</div>
                            <div class="stat-label">Monthly Updates</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addClientModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;">Add New Client</h2>
            <form id="addClientForm">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">ART Number *</label>
                        <input type="text" name="artNumber" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" name="fullName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age *</label>
                        <input type="number" name="age" class="form-input" min="0" max="120" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender *</label>
                        <select name="gender" class="form-input" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" name="phone" class="form-input" placeholder="09xxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Village/Address *</label>
                        <input type="text" name="address" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Drug Pickup</label>
                        <input type="date" name="lastPickup" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Pickup Due</label>
                        <input type="date" name="nextPickup" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last VL Collection</label>
                        <input type="date" name="lastVL" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next VL Due</label>
                        <input type="date" name="nextVL" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">GPS Coordinates</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" name="coordinates" class="form-input" placeholder="Latitude, Longitude" style="flex: 1;">
                        <button type="button" class="btn" onclick="getCurrentLocation('coordinates')" style="white-space: nowrap;">üìç Get Location</button>
                    </div>
                    <small style="color: #666; font-size: 12px;">Use 'Get Location' when at client's home for accurate tracing</small>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button type="submit" class="btn">üíæ Save Client</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addClientModal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;">Import Client Data</h2>
            <div class="alert alert-info">
                <h4>üìã Supported File Formats:</h4>
                <p>‚Ä¢ Excel files (.xlsx, .xls)</p>
                <p>‚Ä¢ CSV files (.csv)</p>
                <p>‚Ä¢ Text files (.txt) with comma separation</p>
                <p>‚Ä¢ Maximum file size: 10MB</p>
            </div>
            <div class="file-upload" onclick="document.getElementById('importFile').click()">
                <h3>üìÅ Click to Upload Data File</h3>
                <p style="color: #666; margin-top: 10px;">Drag & Drop or Click to Browse</p>
                <input type="file" id="importFile" accept=".csv,.xlsx,.xls,.txt" style="display: none;" onchange="handleFileUpload(this)">
            </div>
            <div id="importPreview" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Client Details Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('clientModal')">&times;</span>
            <div id="clientModalContent">
                <!-- Client details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Client Trace Modal -->
    <div id="traceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('traceModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;">üó∫Ô∏è Client Tracing</h2>
            <div id="traceModalContent">
                <!-- Trace details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Update Tracking Modal -->
    <div id="trackingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('trackingModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;">Update Client Tracking</h2>
            <form id="trackingForm">
                <input type="hidden" id="trackingClientId">
                <div class="form-group">
                    <label class="form-label">Intervention Type *</label>
                    <select id="interventionType" class="form-input" required>
                        <option value="">Select Intervention</option>
                        <option value="phone_call">üìû Phone Call</option>
                        <option value="home_visit">üè† Home Visit</option>
                        <option value="community_health_worker">üë• Community Health Worker</option>
                        <option value="family_member">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Member Contact</option>
                        <option value="peer_educator">ü§ù Peer Educator</option>
                        <option value="facility_visit">üè• Facility Visit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Findings & Actions Taken *</label>
                    <textarea id="findings" class="form-input" rows="4" placeholder="Describe your findings and actions taken..." required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Client Response</label>
                    <select id="clientResponse" class="form-input">
                        <option value="">Select Response</option>
                        <option value="contacted">‚úÖ Successfully Contacted</option>
                        <option value="no_response">‚ùå No Response</option>
                        <option value="phone_off">üìµ Phone Off/Unreachable</option>
                        <option value="wrong_number">üìû Wrong Number</option>
                        <option value="relocated">üìç Client Relocated</option>
                        <option value="visited_facility">üè• Visited Facility</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-up Date</label>
                    <input type="date" id="followupDate" class="form-input">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">üíæ Save Tracking</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('trackingModal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update Client Status Modal (PC Only) -->
    <div id="statusUpdateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('statusUpdateModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;">Update Client Status</h2>
            <div class="alert alert-warning">
                <p><strong>‚ö†Ô∏è Professional Counselor Authorization Required</strong></p>
                <p>This action will change the client's TX-Curr status and requires proper documentation.</p>
            </div>
            <div id="statusClientInfo" style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>
            <form id="statusUpdateForm">
                <input type="hidden" id="statusClientId">
                <div class="form-group">
                    <label class="form-label">New Status *</label>
                    <select id="newStatus" class="form-input" required onchange="toggleStatusFields()">
                        <option value="">Select Status</option>
                        <option value="defaulter">üö´ Defaulter (28+ days overdue)</option>
                        <option value="iit">‚è∏Ô∏è IIT (Interruption in Treatment)</option>
                        <option value="dead">üíÄ Dead</option>
                        <option value="transfer_out">üì§ Transfer Out</option>
                        <option value="reactivate">üîÑ Reactivate (Return to Active)</option>
                    </select>
                </div>
                
                <!-- Fields for Dead status -->
                <div id="deadFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Date of Death *</label>
                        <input type="date" id="dateOfDeath" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cause of Death *</label>
                        <select id="causeOfDeath" class="form-input">
                            <option value="">Select Cause</option>
                            <option value="hiv_related">HIV Related</option>
                            <option value="tb_related">TB Related</option>
                            <option value="covid_related">COVID-19 Related</option>
                            <option value="non_hiv_related">Non-HIV Related</option>
                            <option value="unknown">Unknown</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Additional Details</label>
                        <textarea id="deathDetails" class="form-input" rows="3" placeholder="Additional details about cause of death..."></textarea>
                    </div>
                </div>
                
                <!-- Fields for Transfer Out -->
                <div id="transferFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Transfer Date *</label>
                        <input type="date" id="transferDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Province *</label>
                        <select id="transferProvince" class="form-input">
                            <option value="">Select Province</option>
                            <option value="Copperbelt">Copperbelt</option>
                            <option value="Lusaka">Lusaka</option>
                            <option value="Central">Central</option>
                            <option value="Eastern">Eastern</option>
                            <option value="Luapula">Luapula</option>
                            <option value="Muchinga">Muchinga</option>
                            <option value="Northern">Northern</option>
                            <option value="North-Western">North-Western</option>
                            <option value="Southern">Southern</option>
                            <option value="Western">Western</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">District *</label>
                        <input type="text" id="transferDistrict" class="form-input" placeholder="e.g., Kitwe">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Receiving Facility *</label>
                        <input type="text" id="transferFacility" class="form-input" placeholder="Name of receiving facility">
                    </div>
                </div>
                
                <!-- Fields for Reactivation -->
                <div id="reactivateFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Return Date *</label>
                        <input type="date" id="returnDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Pickup Due *</label>
                        <input type="date" id="newNextPickup" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Professional Counselor Notes *</label>
                    <textarea id="statusNotes" class="form-input" rows="4" placeholder="Professional counselor notes and justification for status change..." required></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-danger">üíæ Update Status</button>
                    <button type="button" class="btn" onclick="closeModal('statusUpdateModal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div id="editClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editClientModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;">Edit Client Information</h2>
            <form id="editClientForm">
                <input type="hidden" id="editClientId">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">ART Number *</label>
                        <input type="text" id="editArtNumber" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="editFullName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age *</label>
                        <input type="number" id="editAge" class="form-input" min="0" max="120" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender *</label>
                        <select id="editGender" class="form-input" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" id="editPhone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Village/Address *</label>
                        <input type="text" id="editAddress" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Drug Pickup</label>
                        <input type="date" id="editLastPickup" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Pickup Due</label>
                        <input type="date" id="editNextPickup" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last VL Collection</label>
                        <input type="date" id="editLastVL" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next VL Due</label>
                        <input type="date" id="editNextVL" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">GPS Coordinates</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="editCoordinates" class="form-input" placeholder="Latitude, Longitude" style="flex: 1;">
                        <button type="button" class="btn" onclick="getCurrentLocation('editCoordinates')" style="white-space: nowrap;">üìç Update Location</button>
                    </div>
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button type="submit" class="btn">üíæ Save Changes</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('editClientModal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;">Request Account Access</h2>
            <form id="registerForm">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" name="fullName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" name="username" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" name="email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" name="phone" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role Requested *</label>
                        <select name="role" class="form-input" required>
                            <option value="">Select Role</option>
                            <option value="lay_counselor">Lay Counselor</option>
                            <option value="professional_counselor">Professional Counselor</option>
                            <option value="clinician">Clinician</option>
                            <option value="hub_coordinator">HTS Hub Coordinator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Primary Facility *</label>
                        <select name="facility" class="form-input" id="registerFacilitySelect" required>
                            <option value="">Select Facility</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" name="password" class="form-input" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password *</label>
                        <input type="password" name="confirmPassword" class="form-input" required>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">üìù Submit Request</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('registerModal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Facility Modal -->
    <div id="addFacilityModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addFacilityModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #2d3748;" id="facilityModalTitle">Add New Facility</h2>
            <form id="facilityForm">
                <input type="hidden" id="facilityId">
                <div class="form-group">
                    <label class="form-label">Facility Name *</label>
                    <input type="text" id="facilityName" class="form-input" required>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Location/District *</label>
                        <input type="text" id="facilityLocation" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Province *</label>
                        <select id="facilityProvince" class="form-input" required>
                            <option value="">Select Province</option>
                            <option value="Copperbelt">Copperbelt</option>
                            <option value="Lusaka">Lusaka</option>
                            <option value="Central">Central</option>
                            <option value="Eastern">Eastern</option>
                            <option value="Luapula">Luapula</option>
                            <option value="Muchinga">Muchinga</option>
                            <option value="Northern">Northern</option>
                            <option value="North-Western">North-Western</option>
                            <option value="Southern">Southern</option>
                            <option value="Western">Western</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Facility Type *</label>
                        <select id="facilityType" class="form-input" required>
                            <option value="">Select Type</option>
                            <option value="hospital">Hospital</option>
                            <option value="clinic">Clinic</option>
                            <option value="health_post">Health Post</option>
                            <option value="health_center">Health Center</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact Phone</label>
                        <input type="tel" id="facilityPhone" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea id="facilityAddress" class="form-input" rows="3" placeholder="Full facility address"></textarea>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">üíæ Save Facility</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addFacilityModal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Facility Selection Modal -->
    <div id="facilitySelectionModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Select Your Facility</h2>
            <div class="alert alert-info">
                <p><strong>Facility Access Control:</strong></p>
                <p>You can only view and manage clients from your selected facility for data security and privacy.</p>
            </div>
            <div id="facilitySelectionList">
                <!-- Facility selection will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let userRole = null;
        let currentFacilityId = null;
        let currentFacilityName = null;
        let userFacilities = [];
        let clients = [];
        let facilities = [];
        let accountRequests = [];
        let notifications = [];

        // Enhanced Sample Data
        const sampleFacilities = [
            { 
                id: 'kitwe_central', 
                name: 'Kitwe Central Hospital', 
                location: 'Kitwe Central', 
                province: 'Copperbelt',
                type: 'hospital',
                phone: '0212-220-000',
                address: 'Independence Avenue, Kitwe Central, Copperbelt Province',
                active: true 
            },
            { 
                id: 'wusakile', 
                name: 'Wusakile Clinic', 
                location: 'Wusakile Compound', 
                province: 'Copperbelt',
                type: 'clinic',
                phone: '0212-225-000',
                address: 'Wusakile Compound, Kitwe, Copperbelt Province',
                active: true 
            },
            { 
                id: 'riverside', 
                name: 'Riverside Clinic', 
                location: 'Riverside Township', 
                province: 'Copperbelt',
                type: 'clinic',
                phone: '0212-228-000',
                address: 'Riverside Township, Kitwe, Copperbelt Province',
                active: true 
            },
            { 
                id: 'kamkole', 
                name: 'Kamkole Health Post', 
                location: 'Kamkole Village', 
                province: 'Copperbelt',
                type: 'health_post',
                phone: '0212-230-000',
                address: 'Kamkole Village, Kitwe Rural, Copperbelt Province',
                active: true 
            },
            { 
                id: 'ndola_general', 
                name: 'Ndola General Hospital', 
                location: 'Ndola Central', 
                province: 'Copperbelt',
                type: 'hospital',
                phone: '0212-610-000',
                address: 'Buteko Avenue, Ndola, Copperbelt Province',
                active: true 
            }
        ];

        const sampleClients = [
            {
                id: 1,
                artNumber: 'KCH/001/2024',
                fullName: 'John Banda',
                age: 35,
                gender: 'Male',
                phone: '0971234567',
                address: 'Wusakile Compound, Section 2',
                coordinates: '-12.8065, 28.2137',
                lastPickup: '2024-07-20',
                nextPickup: '2024-08-20',
                lastVL: '2024-06-15',
                nextVL: '2024-12-15',
                lastCervical: null,
                nextCervical: null,
                status: 'active',
                txCurrStatus: 'active',
                tracking: [],
                facilityId: 'kitwe_central',
                statusHistory: []
            },
            {
                id: 2,
                artNumber: 'RSC/002/2024',
                fullName: 'Mary Mwanza',
                age: 28,
                gender: 'Female',
                phone: '0977654321',
                address: 'Riverside Township, Block A',
                coordinates: '-12.8025, 28.2087',
                lastPickup: '2024-06-15',
                nextPickup: '2024-07-15',
                lastVL: '2024-05-20',
                nextVL: '2024-11-20',
                lastCervical: '2024-01-15',
                nextCervical: '2025-01-15',
                status: 'defaulter',
                txCurrStatus: 'inactive',
                tracking: [
                    {
                        date: '2024-08-01',
                        intervention: 'phone_call',
                        findings: 'Phone call - no response, phone switched off',
                        response: 'no_response',
                        counselor: 'James Mwape'
                    },
                    {
                        date: '2024-08-05',
                        intervention: 'home_visit',
                        findings: 'Home visit - neighbors report client traveled to village',
                        response: 'relocated',
                        counselor: 'James Mwape'
                    }
                ],
                facilityId: 'riverside',
                statusHistory: [
                    {
                        date: '2024-08-10',
                        status: 'defaulter',
                        updatedBy: 'Dr. Susan Phiri',
                        notes: 'Client 45+ days overdue with unsuccessful tracing attempts'
                    }
                ]
            },
            {
                id: 3,
                artNumber: 'WCL/003/2024',
                fullName: 'Peter Mulenga',
                age: 42,
                gender: 'Male',
                phone: '0965432109',
                address: 'Wusakile Compound, Section 5',
                coordinates: '-12.7995, 28.2157',
                lastPickup: '2024-07-25',
                nextPickup: '2024-08-10',
                lastVL: '2024-04-10',
                nextVL: '2024-10-10',
                status: 'active',
                txCurrStatus: 'active',
                tracking: [
                    {
                        